<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>BookYan</title>
  <link href="styles/styles.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100..900&display=swap" rel="stylesheet" type="text/css">
 
</head>

<body>
  <div class="wrapper">
    <header class="container">
      <img src="/img/logo1.png" alt="Error 404">
      <nav>
        <ul>
          <li class="active"><a href="/Моя первая страница.html">Home</a></li>
          <li><a href="/aboutAs.html">About as</a></li>
          <li><a href="/reservation.html">Reservations</a></li>
          <li><a href="/penalty.html">Penalties</a></li>
          <li><a href="/contacts.html">Contacts</a></li>
          <!-- ссылка на конец главной страницы -->
          <li id="registerNav" class="btn"><a href="/Моя первая страница.html#bottom">РЕГИСТРАЦИЯ</a></li>
          <li id="authItem"><button onclick="authorize()">Авторизация</button></li>
        </ul>
      </nav>
    </header>

    <div class="hero container">
      <div class="hero-info">
        <h1><strong>BookYan - Самый популярный книжный магазин на Закавказье</strong></h1>
        <h2>Скидка 30% при покупке двух книг из новогодней коллекции</h2>
        <button class="btn" onclick="location.href='/Моя первая страница.html#bottom'">Смотреть каталог</button>
      </div>
      <img src="/img/orig.jpg" alt="Что-то понло не по плану">
    </div>

    <div class="container reading">
      <a href="#" class="see-all">SEE ALL</a>
      <h2>Best Seller Books</h2>

      <div class="books">
        <div class="block">
          <img src="/img/levshi.png" alt="Картинка">
          <span><img src="/img/onfire4x_86979.png" alt=""> «Леший (комедия в 4-х действиях)» </span>
        </div>
        <div class="block">
          <img src="/img/doch.png" alt="Картинка">
          <span><img src="/img/onfire4x_86979.png" alt=""> «Наталья, боярская дочь»</span>
        </div>
        <div class="block">
          <img src="/img/egipt.png" alt="Картинка">
          <span><img src="/img/onfire4x_86979.png" alt=""> «Египетские ночи» </span>
        </div>
      </div>
    </div>

    <div class="container bigtext">
      <p>Самая популярная книга на данный момент</p>
    </div>

    <div class="container banner">
      <div class="banner-text">
        <h3>Самая популярная книга</h3>
        <p>Книга «Самый богатый человек в Вавилоне» Джорджа Клейсона — это сборник притч, 
          которые учат управлять деньгами через простые, но универсальные принципы. 
          Автор использует притчи из жизни жителей Древнего Вавилона, 
          чтобы объяснить сложные экономические концепции простым и понятным языком</p>
      </div>
      <img src="/img/book2.0.jpg" alt="">
    </div>
  </div>

  <div class="features">
    <div class="container">
      <h2>Рекомендуемые книги от нашего сайта</h2>
      <p>Мы подобрали по Вашим интересам несколько книг, которые отправляют нас в необыкновенные путешествия</p>
      <div class="books">
        <div class="block">
          <img src="/img/kiti.jpg" alt="">
          <p>"КОН-ТИКИ"</p>
          <span><img src="/img/right-arrow_4983204.png" alt=""></span>
        </div>
        <div class="block">
          <img src="/img/shantaram.jpg" alt="">
          <p>"ШАНТАРАМ"</p>
          <span><img src="/img/right-arrow_4983204.png" alt=""></span>
        </div>
        <div class="block">
          <img src="/img/80_let.jpg" alt="">
          <p>"ВОКРУГ СВЕТА ЗА 80 ДНЕЙ"</p>
          <span><img src="/img/right-arrow_4983204.png" alt=""></span>
        </div>
        <div class="block">
          <img src="/img/eat.jpg" alt="">
          <p>"ЕСТЬ, МОЛИТЬСЯ, ЛЮБИТЬ"</p>
          <span><img src="/img/right-arrow_4983204.png" alt=""></span>
        </div>
      </div>
    </div>
  </div>

  <div class="wrapper">
    <div class="container books">
      <h3>Новые книги!!!</h3>
      <p>На сайте появились книги, которых ещё нигде нет!</p>
      <div class="block1">
        <img src="/img/hadid.jpg" alt="">
        <img src="/img/hokwarts.jpg" alt="">
        <img src="/img/talant.jpg" alt="">
      </div>
      <div class="block1">
        <img src="/img/zemlya.jpg" alt="">
        <img src="/img/teli.jpg" alt="">
        <img src="/img/taini.jpg" alt="">
      </div>
      <a href="#" class="see-all">SEE ALL</a>
    </div>

    <!-- Форма регистрации -->
    <div class="container email" id="registrationSection">
      <h2>Регистрация</h2>
      <p>Зарегистрируйся сегодня и получи скидку в размере 45% на первую книгу!!!</p>
      <div class="block">
        <div>
          <h3>Окно регистрации</h3>
        </div>
        <div>
          <input id="regFullName" placeholder="Введите имя" />
          <input id="regEmail" type="email" placeholder="Введите email" />
          <input id="regPassword" type="password" placeholder="Введите пароль" />
          <button id="regBtn">Продолжить</button>
          <div id="regMsg"></div>
          <div id="tokenDisplay" class="hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="container blocks">
      <div>
        <span class="logo">BookYan</span>
        <p>Мы очень рады, что вы зашли на наш сайт</p>
      </div>
      <div>
        <h4>Contacts</h4>
        <ul>
          <li>+7-495-777-77-77</li>
          <li>BookYan@mail.ru</li>
        </ul>
      </div>
      <div>
        <h4>Messengers</h4>
        <ul>
          <li><a href="#">ВКонтакте</a></li>
          <li><a href="#">Instagramm</a></li>
          <li><a href="#">Telegramm</a></li>
        </ul>
      </div>
    </div>
    <hr>
    <p>Заходите ещё!</p>
  </footer>

  <!-- якорь в конце страницы -->
  <div id="bottom" style="height:1px; visibility:hidden;"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('regBtn').addEventListener('click', register);
      updateNavigation();
    });

    async function register() {
      const fullName = document.getElementById('regFullName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const msg = document.getElementById('regMsg');
      const tokenDisplay = document.getElementById('tokenDisplay');
      
      msg.textContent = '';
      msg.className = '';
      tokenDisplay.textContent = '';
      tokenDisplay.className = 'hidden';

      if (!fullName) {
        msg.textContent = 'Введите имя.';
        msg.className = 'error';
        return;
      }

      if (!isValidEmail(email)) {
        msg.textContent = 'Неверный email.';
        msg.className = 'error';
        return;
      }

      if (!password || password.length < 6) {
        msg.textContent = 'Пароль должен содержать минимум 6 символов.';
        msg.className = 'error';
        return;
      }

      try {
        // 1. Сначала регистрируем пользователя
        const registerResponse = await fetch('http://localhost:5236/User/RegisterUser', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            FullName: fullName,
            Email: email,
            PasswordHash: password
          })
        });

        if (registerResponse.ok) {
          const id = await registerResponse.json();
          
          // 2. После успешной регистрации выполняем вход для получения токена
          const loginResponse = await fetch('http://localhost:5236/User/loginUser', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              Email: email,
              PasswordHash: password
            })
          });

          if (loginResponse.ok) {
            const token = await loginResponse.text();
            
            // Сохраняем токен в localStorage
            localStorage.setItem('authToken', token);
            
            // Получаем информацию о пользователе
            const userResponse = await fetch('http://localhost:5236/User/Me', {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });
            
            if (userResponse.ok) {
              const user = await userResponse.json();
              localStorage.setItem('currentUser', JSON.stringify(user));
              
              msg.textContent = 'Регистрация успешна! Токен получен.';
              msg.className = 'success';
              
              // Показываем токен пользователю
              tokenDisplay.textContent = `Ваш токен: ${token}`;
              tokenDisplay.className = 'success';
              
              // Очистка полей
              document.getElementById('regFullName').value = '';
              document.getElementById('regEmail').value = '';
              document.getElementById('regPassword').value = '';
              
              // Скрываем кнопку регистрации, но НЕ обновляем навигацию полностью
              // чтобы кнопка авторизации осталась
              document.getElementById('registerNav').classList.add('hidden');
              
              // Не вызываем updateNavigation() здесь, чтобы кнопка авторизации оставалась
            } else {
              msg.textContent = 'Ошибка получения данных пользователя';
              msg.className = 'error';
            }
          } else {
            const loginError = await loginResponse.text();
            msg.textContent = 'Регистрация успешна, но вход не выполнен: ' + loginError;
            msg.className = 'error';
          }
        } else {
          const errorText = await registerResponse.text();
          msg.textContent = errorText || 'Ошибка регистрации';
          msg.className = 'error';
        }
      } catch (err) {
        console.error('Сетевая ошибка:', err);
        msg.textContent = 'Сетевая ошибка: ' + err.message;
        msg.className = 'error';
      }
    }

    async function authorize() {
      // Проверяем, есть ли уже токен в localStorage
      const existingToken = localStorage.getItem('authToken');
      
      if (existingToken) {
        // Если токен уже есть, используем его для авторизации
        try {
          const response = await fetch('http://localhost:5236/User/Me', {
            headers: {
              'Authorization': `Bearer ${existingToken}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const user = await response.json();
            localStorage.setItem('currentUser', JSON.stringify(user));
            updateNavigation();
            alert(`Добро пожаловать, ${user.fullName}!`);
          } else {
            // Если токен невалидный, запрашиваем новый
            const token = prompt('Введите ваш токен:');
            if (!token) return;
            await validateToken(token);
          }
        } catch (err) {
          console.error('Ошибка авторизации:', err);
          const token = prompt('Введите ваш токен:');
          if (!token) return;
          await validateToken(token);
        }
      } else {
        // Если токена нет, запрашиваем его
        const token = prompt('Введите ваш токен:');
        if (!token) return;
        await validateToken(token);
      }
    }

    async function validateToken(token) {
      try {
        const response = await fetch('http://localhost:5236/User/Me', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const user = await response.json();
          localStorage.setItem('authToken', token);
          localStorage.setItem('currentUser', JSON.stringify(user));
          updateNavigation();
          alert(`Добро пожаловать, ${user.fullName}!`);
        } else {
          alert('Неверный токен!');
        }
      } catch (err) {
        console.error('Ошибка авторизации:', err);
        alert('Ошибка авторизации: ' + err.message);
      }
    }

    function isValidEmail(email) {
      if (!email) return false;
      const at = email.indexOf('@');
      const dot = email.lastIndexOf('.');
      return at > 0 && dot > at + 1 && dot < email.length - 1;
    }

    function updateNavigation() {
      const token = localStorage.getItem('authToken');
      const currentUser = localStorage.getItem('currentUser');
      const registerNav = document.getElementById('registerNav');
      const authItem = document.getElementById('authItem');

      if (token && currentUser) {
        // Пользователь авторизован - скрываем Register, меняем кнопку авторизации на "Выйти"
        registerNav.classList.add('hidden');
        
        const user = JSON.parse(currentUser);
        authItem.innerHTML = `
          <span id="userWelcome">Добро пожаловать, ${user.fullName}! </span>
          <button onclick="logout()">Выйти</button>
        `;
        
        // Включаем права доступа для зарегистрированного пользователя
        enableUserFeatures(user.role);
      } else {
        // Пользователь не авторизован
        // Кнопка регистрации может быть скрыта или показана в зависимости от того, был ли пользователь зарегистрирован
        // Но кнопка авторизации всегда должна быть видна
        authItem.innerHTML = '<button onclick="authorize()">Авторизация</button>';
        
        // Отключаем права доступа
        disableUserFeatures();
      }
    }

    function enableUserFeatures(role) {
      console.log(`Включен доступ для роли: ${role}`);
      // Здесь можно добавить логику для включения дополнительных функций
    }

    function disableUserFeatures() {
      console.log('Функции ограничены - требуется вход');
    }

    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      updateNavigation();
      alert('Вы вышли из системы');
    }

    // Надёжная прокрутка на якорь после загрузки, если в URL есть #bottom
    window.addEventListener('load', () => {
      if (location.hash === '#bottom') {
        const el = document.getElementById('bottom');
        if (el) {
          setTimeout(() => el.scrollIntoView({ behavior: 'smooth' }), 50);
        }
      }
    });
  </script>
</body>
</html>
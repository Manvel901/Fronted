<!DOCTYPE html>
<html>

<head>
     <meta charset="utf-8">
     <title>BookYan</title>
     <link href="styles/styles.css" rel="stylesheet" type= "text/css">
   <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"  type= "text/css">
</head>

<body>
  
    <header class="container">
     <img src="/img/logo1.png" alt="Error 404">
      <nav>
        <ul>
          <li><a href="/Моя первая страница.html">Home</a></li>
          <li><a href="/aboutAs.html">About as</a></li>
          
          <li class="active"><a href="/reservation.html">Reservations</a></li>
          <li><a href="/penalty.html">Penalties</a></li>
          <li><a href="/contacts.html">Contacts</a></li>
         <li class="btn"><a href="/Моя первая страница.html#bottom">Register</a></li>
        </ul>
      </nav>
    </header>
   
    <div class="container reservation">
        <div class="info">
            <h1>Бронирование и доставка — зарезервируйте книгу онлайн</h1>
            <p>Не нашли нужную книгу в наличии или хотите гарантировать получение новинки — оставьте бронирование: 
                укажите название, автора и удобную дату получения; мы удержим экземпляр в магазине в течение 72 часов, 
                вышлем подтверждение на почту и можем отправить книгу в любую точку мира удобной вам службой доставки.</p>
                
        </div>
        <img src="/img/bookin.webp" alt="">
    </div>
    <div class="reservback">
      <div class="container">
         <h2>Окно для бронирования</h2>
         <h4>Закажи сейчас и получи 30% скидку на следующую покупку.</h4>
         
         <form>
          <div class="inline">
            <div>
              <label>Название книги</label>
             <input type="text" id="book" placeholder="Введите название книги" required>
            </div>
            <div>
              <label>Автор</label>
             <input type="text" class="author" placeholder="Введите имя автора" required>
            </div>
              
          </div>
          <button onclick=reserv() type="button">Забронировать</button>
         </form>
           


         
         <div class="block">

           <p>С уважением и любовью</p>
           <p>Ваш BookYan</p>
         </div>
      </div>
    </div>
  <script>
    
      function contacts() {
    let name = document.querySelector('#firstName').value;
    let surname = document.querySelector('#lastName').value; // Исправлено
    let email = document.querySelector('#emailField').value; // Исправлено
    let message = document.querySelector('#messageField').value; // Исправлено

    // Проверяем, заполнены ли все поля
    if (!name || !surname || !email || !message) {
        alert("Ошибка!! Не все поля заполнены!");
    } else {
        alert("Ваш отзыв успешно отправлен");
    }
}
  </script>

  <script>

async function reserv() {
    const bookTitle = document.querySelector('#book').value.trim();
    const bookAuthors = Array.from(document.querySelectorAll('.author'))
        .map(input => input.value.trim())
        .filter(name => name);

    // Проверка на заполнение полей
    if (!bookTitle || bookAuthors.length === 0) {
        alert("Не все поля заполнены!");
        return;
    }

    // Получаем токен
    const token = localStorage.getItem('authToken');

    if (!token) {
        alert('Вы не авторизованы! Пожалуйста, войдите в систему.');
        return;
    }

    // ИСПРАВЛЕНО: меняем AuthorsName на AuthorName
   const body = { 
    BookTitle: bookTitle, 
    AuthorName: bookAuthors[0] // Только первый автор
};

    console.log('Отправка запроса на бронирование:', body);

    try {
        const res = await fetch('http://localhost:5236/Reservation/CreateReservationByTitle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(body)
        });

        console.log('Статус ответа:', res.status);

        // Обработка ответа от сервера
        if (res.ok) {
            const data = await res.json();
            alert('✅ Книга успешно забронирована! ID: ' + (data.id ?? data.Id ?? 'неизвестен'));
            
            // Очищаем поля формы после успешного бронирования
            document.querySelector('#book').value = '';
            document.querySelectorAll('.author').forEach(input => input.value = '');
        } else if (res.status === 401) {
            alert('❌ Ошибка авторизации. Пожалуйста, войдите в систему снова.');
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
        } else if (res.status === 404) {
            const text = await res.text();
            alert('❌ Не найдено: ' + text);
        } else if (res.status === 400) {
            // Детальная обработка ошибок валидации
            const errorData = await res.json();
            console.error('Ошибки валидации:', errorData.errors);
            
            if (errorData.errors && errorData.errors.AuthorName) {
                alert('❌ Ошибка в поле автора: ' + errorData.errors.AuthorName.join(', '));
            } else {
                alert('❌ Ошибка валидации: ' + JSON.stringify(errorData.errors));
            }
        } else {
            const text = await res.text();
            alert('❌ Ошибка: ' + (text || res.statusText));
        }
    } catch (err) {
        console.error('Ошибка бронирования:', err);
        alert('❌ Сетевая ошибка: ' + err.message);
    }
}

</script>

  <footer>
    <div class="container blocks">
      <div>
        <span class="logo">BookYan</span>
        <p>Мы очень рады, что вы зашли на наш сайт</p>
      </div>
      <div>
        <h4>Contacts</h4>
        <ul>
          <li>+7-495-777-77-77</li>
          <li>BookYan@mail.ru</li>
          
        </ul>
      </div>
      <div>
        <h4>Messengers</h4>
        <ul>
          <li><a href="#">ВКонтакте</a></li>
          <li><a href="#">Instagramm</a></li>
          <li><a href="#">Telegramm</a></li>
        </ul>
      </div>
    </div>
    <hr>
    <p>Заходите ещё!</p>
  </footer>
</body>
</html>
